<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Quadrotor Gamepad Controller</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px; /* Increased width to accommodate new column */
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        #gamepad-status {
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-weight: bold;
        }
        .gamepad-connected {
            background-color: #d4edda;
            color: #155724;
        }
        .gamepad-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        #gamepad-state{
            display: table;
            border-spacing: 1rem;
            border-collapse: separate;
        }
        .gamepad-controls-row {
            display: table-row;
            margin-bottom: 5px;
        }
        .gamepad-controls-cell {
            display: table-cell;
            margin: 10px;
            vertical-align: middle;
            margin-bottom: 5px;
        }
        .gamepad-slider-container {
            position: relative;
            height: 30px;
        }
        .gamepad-slider {
            width: 100px;
            height: 10px;
            pointer-events: none;
        }
        .gamepad-button-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #ccc;
        }
        #gamepad-button-container {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        .gamepad-button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        .gamepad-button:hover {
            background-color: #0069d9;
        }
        .gamepad-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .gamepad-value-display, .gamepad-raw-value-display {
            text-align: right;
            font-family: monospace;
        }
        .gamepad-raw-value-display {
            color: #555; /* Slightly muted to distinguish from processed value */
        }
        .gamepad-mapping-button {
        }
        .gamepad-main-button {
            grid-column: span 2;
        }
        .gamepad-reset-button{
            background-color: #cb2c2c;
        }
        .gamepad-reset-button:hover {
            background-color: #942121;
        }
        .gamepad-separator {
            height: 1px;
            background-color: #ddd;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <template id="gamepad-axis-template">
        <div class="gamepad-controls-row">
            <div class="gamepad-controls-name gamepad-controls-cell"></div>
            <div class="gamepad-slider-container gamepad-controls-cell"><input type="range" class="gamepad-slider" min="-1" max="1" value="0" step="0.01" disabled></div>
            <div class="gamepad-value-display gamepad-controls-cell">0.00</div>
        </div>
    </template>
    <template id="gamepad-button-template">
        <div class="gamepad-controls-row">
            <div class="gamepad-controls-name gamepad-controls-cell"></div>
            <div class="gamepad-controls-cell"><div class="gamepad-button-indicator"></div></div>
            <div class="gamepad-value-display gamepad-controls-cell">Released</div>
            <div></div>
        </div>
    </template>
    <template id="gamepad-template">
        <div id="gamepad-status" class="gamepad-disconnected">No gamepad connected</div>
        <div id="gamepad-state">

        </div>
        <div id="gamepad-button-container">
        </div>
    </template>
    <h1>Quadrotor Gamepad Controller</h1>
    <script>
        /*
        mapping button
        mapping_state
          live_index
          active
        controlMap
        callbacks

        */
        class Mapper{
            constructor(type, name, gamepad, control_map, completion_handler){
                this.type = type
                this.name = name
                this.active = false
                this.index = -1
                this.live_index = -1
                this.max_deflection = 0
                this.base = null
                this.invert = false
                this.base_values = {}
                this.control_map = control_map
                for (let i = 0; i < gamepad.axes.length; i++) {
                    this.base_values[i] = gamepad.axes[i];
                }
                this.finished = false
                this.completion_handler = completion_handler
            }
            handle_mapping_axis(gamepad){
                if (!this.active) {
                    let maxDiff = 0;
                    for (let i = 0; i < gamepad.axes.length; i++) {
                        const diff = Math.abs(gamepad.axes[i] - this.base_values[i]);
                        if(i == 0){
                            console.log(`Axis ${i}: ${gamepad.axes[i]}`);
                        }
                        if (diff > maxDiff) {
                            maxDiff = diff;
                            this.live_index = i;
                            this.base = this.base_values[i];
                        }
                        if (diff > 0.5) {
                            this.base = this.base_values[i];
                            this.active = true;
                            this.index = i;
                            const movement = gamepad.axes[i] - this.base_values[i];
                            this.invert = movement < 0;
                            break;
                        }
                    }
                } else {
                    const value = gamepad.axes[this.index];
                    const deflection = Math.abs(value - this.base);
                    if (deflection > this.max_deflection) {
                        this.max_deflection = deflection;
                    } 
                    if (this.max_deflection - deflection > 0.1){
                        this.finished = true
                    }
                }
                // live_view
                const was_not_mapped = this.control_map[this.name] === undefined;
                this.control_map[this.name] = { 
                    type: 'axis', 
                    index: this.active ? this.index : this.live_index, 
                    invert: this.invert,
                    base: this.base,
                    max_deflection: this.max_deflection,
                    finished: this.finished
                };
                if(this.finished){
                    this.completion_handler();
                }
                return was_not_mapped
            }
            handle_mapping_button(gamepad){
                for (let i = 0; i < gamepad.buttons.length; i++) {
                    if (gamepad.buttons[i].pressed) {
                        this.control_map[this.name] = { type: 'button', index: i};
                        this.completion_handler()
                        return false;
                    }
                }
                return false
            }
            handle_mapping(gamepad){
                if(this.type === 'axis'){
                    return this.handle_mapping_axis(gamepad);
                } else if(this.type === 'button'){
                    return this.handle_mapping_button(gamepad);
                }
            }
        }
        class Gamepad{
            constructor(parent, gamepad_interface){
                const template = document.getElementById('gamepad-template');
                const clone = template.content.cloneNode(true);
                parent.appendChild(clone);
                this.element = parent.lastElementChild;
                this.gamepad_interface = gamepad_interface;
                this.mapper = null;
                this.control_map = {}
                this.callbacks = {}
                this.gamepad_index = null
                this.gamepad_poller = null
                const reset_button = document.createElement('button');
                reset_button.classList.add('gamepad-mapping-button');
                reset_button.classList.add('gamepad-button');
                reset_button.classList.add('gamepad-reset-button')
                reset_button.textContent = "Reset";
                reset_button.onclick = () => {
                    const gamepad = this.get_gamepad();
                    if(gamepad === null) return;
                    this.gamepad_index = null
                    this.control_map = {}
                    this.callbacks = {}
                    const status_element = document.getElementById('gamepad-status');
                    status_element.textContent = 'No gamepad connected';
                    status_element.className = 'gamepad-disconnected';
                    let gamepad_config = localStorage.getItem('gamepad_config');
                    gamepad_config = gamepad_config !== null ? JSON.parse(gamepad_config) : null;
                    if(gamepad_config !== null){
                        delete gamepad_config[gamepad.id];
                        localStorage.setItem('gamepad_config', JSON.stringify(gamepad_config));
                    }
                    document.querySelectorAll('.gamepad-mapping-button').forEach((btn) => { btn.disabled = true; });
                    this.render_live_view()
                };
                document.getElementById("gamepad-button-container").appendChild(reset_button);


                for (const channel in gamepad_interface){
                    const details = gamepad_interface[channel];
                    const button = document.createElement('button');
                    // <button class="gamepad-mapping-button" disabled onclick="startMapping('thrust', 'axis', 'up', this)">Map Thrust Axis</button>
                    button.classList.add('gamepad-mapping-button');
                    button.classList.add('gamepad-button');
                    const default_text = `Map ${channel}`
                    button.textContent = default_text;
                    button.disabled = true;
                    button.onclick = () => {
                        button.textContent = details.type === "button" ? 'Press Button' : `Move ${details.positive_direction}`;
                        document.querySelectorAll('.gamepad-mapping-button').forEach((btn) => { btn.disabled = true; });
                        button.disabled = false;
                        const gamepad = this.get_gamepad();
                        if(this.mapper === null && gamepad !== null){
                            this.mapper = new Mapper(details.type, channel, gamepad, this.control_map, () => {
                                button.textContent = default_text
                                // localStorage.setItem('quadrotorGamepadMap', JSON.stringify(controlMap));
                                document.querySelectorAll('.gamepad-mapping-button').forEach((btn) => { btn.disabled = false; });
                                this.mapper = null
                                let gamepad_config = localStorage.getItem('gamepad_config');
                                gamepad_config = gamepad_config !== null ? JSON.parse(gamepad_config) : {};
                                gamepad_config[gamepad.id] = this.control_map;
                                localStorage.setItem('gamepad_config', JSON.stringify(gamepad_config));
                                this.render_live_view()
                            });
                        }
                    };
                    document.getElementById("gamepad-button-container").appendChild(button);
                }
                this.poll()
            }
            get_gamepad(){
                if(this.gamepad_index === null){
                    const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
                    let new_gamepad = null
                    for (let i = 0; i < gamepads.length; i++) {
                        const gp = gamepads[i];
                        if(gp){
                            this.gamepad_index = gp.index;
                            const status_element = document.getElementById('gamepad-status');
                            status_element.textContent = 'Gamepad connected: ' + gp.id;
                            status_element.className = 'gamepad-connected';
                            document.querySelectorAll('.gamepad-mapping-button').forEach((btn) => { btn.disabled = false; });
                            let gamepad_config = localStorage.getItem('gamepad_config');
                            gamepad_config = gamepad_config !== null ? JSON.parse(gamepad_config) : {};
                            gamepad_config = gp.id in gamepad_config ? gamepad_config[gp.id] : null;
                            if(gamepad_config !== null){
                                this.control_map = gamepad_config;
                                this.render_live_view()
                            }
                            break;
                        }
                    }
                }
                return this.gamepad_index !== null ? navigator.getGamepads()[this.gamepad_index] : null;
            }
            render_live_view(){
                const gamepad_state = document.getElementById('gamepad-state');
                gamepad_state.innerHTML = '';
                this.callbacks = {}
                for (const control in this.control_map) {
                    const details = this.control_map[control];
                    const template = document.getElementById(details.type === 'axis' ? 'gamepad-axis-template' : 'gamepad-button-template');
                    const clone = template.content.cloneNode(true);
                    gamepad_state.appendChild(clone);
                    const name = gamepad_state.lastElementChild.querySelector('.gamepad-controls-name');
                    name.textContent = control
                    const element = gamepad_state.lastElementChild
                    this.callbacks[control] = (value) =>{
                        const slider = element.querySelector('.gamepad-slider');
                        const valueDisplay = element.querySelector('.gamepad-value-display');
                        if (details.type === 'axis') {
                            slider.value = value;
                            console.log(`${control} value: ${value}`);
                            valueDisplay.textContent = value.toFixed(2);
                        } else {
                            const buttonIndicator = element.querySelector('.gamepad-button-indicator');
                            buttonIndicator.style.backgroundColor = value ? '#28a745' : '#ccc';
                            valueDisplay.textContent = value ? 'Pressed' : 'Released';
                        }
                    };
                }
            }
            update_live_view(gamepad){
                for (const control in this.control_map) {
                    const details = this.control_map[control];
                    if(details.index === -1) continue;
                    const raw_value = gamepad[details.type === 'axis' ? 'axes' : 'buttons'][details.index];
                    if(details.type === 'axis'){
                        const value = (raw_value - details.base);
                        const value_clipped = Math.max(-1, Math.min(1, value));
                        const value_inverted = details.invert ? -value_clipped : value_clipped;
                        this.callbacks[control](value_inverted);
                    }
                    else{
                        this.callbacks[control](raw_value.pressed);
                    }
                }
            }
            poll(){
                requestAnimationFrame(this.poll.bind(this));
                const gamepad = this.get_gamepad();
                if(gamepad){
                    if(this.mapper){
                        const should_render = this.mapper.handle_mapping(gamepad);
                        if(should_render){
                            this.render_live_view();
                        }
                    }
                    this.update_live_view(gamepad)
                }
            }
        }
        function init() {
            const gamepad = new Gamepad(document.body, {
                "thrust": {
                    type: "axis",
                    positive_direction: "Up"
                },
                "roll": {
                    type: "axis",
                    positive_direction: "Right"
                },
                "pitch": {
                    type: "axis",
                    positive_direction: "Forward"
                },
                "yaw": {
                    type: "axis",
                    positive_direction: "Clockwise"
                },
                "reset": {
                    type: "button"
                },
            })
            const saved = null; //localStorage.getItem('quadrotorGamepadMap');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    Object.assign(controlMap, parsed);
                } catch (e) {}
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
